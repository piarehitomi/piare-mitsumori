<index html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>お見積書（B仕上げ・印刷は題名から） v7.3.1R PrintPro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --fg:#111; --muted:#666; --line:#e7e7ea;
    --accent:#0f766e; --bg:#f9fafb; --radius:16px;
    --shade:#f3f4f6; /* 合計の網掛け */
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;padding:0;font-family:"BIZ UDPGothic",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Hiragino Kaku Gothic ProN",Meiryo,"Noto Sans JP",sans-serif;color:var(--fg);background:var(--bg);}
  body{font-size:16px;line-height:1.6;touch-action:manipulation}
  input,button,select,textarea{font-size:16px;min-height:44px}

  header.appbar{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 14px;display:flex;gap:10px;align-items:center;z-index:5}
  header.appbar h1{font-size:18px;margin:0;flex:1}
  header.appbar .actions{display:flex;gap:10px;flex-wrap:wrap}
  header.appbar .actions button{padding:12px 16px;border:1px solid var(--line);background:#fff;border-radius:12px}
  header.appbar .actions button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}

  .container{max-width:1100px;margin:16px auto;padding:0 16px 140px}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 2px 0 rgba(0,0,0,.02);}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){.row{grid-template-columns:1fr}}

  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="tel"], input[type="number"], textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
  textarea{min-height:88px;resize:vertical}
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin_button{-webkit-appearance:none;margin:0}

  table{width:100%;border-collapse:separate;border-spacing:0 0}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:16px;vertical-align:top}
  th{background:#fafafa;font-weight:700}
  button.icon{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px}
  .num{text-align:right}
  .notes-cell input{width:100%}
  .print-only{display:none}

  .grand-wrap{display:flex;justify-content:flex-end;margin-top:12px}
  .grand-wrap table{width:auto;min-width:360px}
  .grand-wrap th, .grand-wrap td{padding:12px;border:none;border-bottom:1px solid var(--line)}
  .grand{font-weight:700;font-size:18px}

  .sheet{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:22px}
  .sheet h2{margin:0 0 12px 0;font-size:24px;border-bottom:2px solid #000;display:inline-block;padding-right:8px}

  /* 会社情報（画面レイアウトは従来どおり） */
  .company-info{text-align:left}
  .brand-block{display:inline-block;text-align:left}
  .company-info .logo{height:auto;object-fit:contain;display:block;margin:0 0 8px 0}
  .company-contacts{line-height:1.7;font-size:14px}
  #brandName{display:inline-block;font-size:16px;line-height:1.7;font-weight:700}

  .company-line{margin-top:10px;display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .line-row{display:flex;gap:12px;align-items:center;justify-content:flex-end;width:100%}
  .line-row .icon{width:120px;height:120px;object-fit:contain}
  .line-row .qr{width:120px;height:120px;object-fit:contain}
  .line-note{font-size:14px;color:#000;text-align:right;width:100%}

  /* 宛名（画面のみ表示） */
  .header-flex{display:flex;justify-content:space-between;align-items:flex-start;margin-top:8px}
  .dest .name{font-weight:700}

  /* ====== 印刷スタイル（B寄り・1枚収め） ====== */
  @media print {
    @page { size: A4; margin: 14mm 14mm; } /* 余白をやや詰めて1枚収め */
    body{background:#fff; font-size:11pt; line-height:1.45; color:#000; }
    header.appbar, .no-print{display:none !important}
    .container{padding:0;margin:0;max-width:100%}
    .card{border:none;box-shadow:none;margin:0;padding:0}

    /* 題名より上は非表示（入力カードなど） */
    .row, .header-flex{display:none !important}

    /* タイトル */
    .sheet{padding:0}
    .sheet h2{font-size:18pt; border-bottom:2pt solid #000; padding-bottom:2pt; margin:0 0 8pt 0}

    /* 宛名ブロック（印刷表示用） */
    .dest-print{display:block; margin:10pt 0 6pt 0; page-break-inside:avoid;}
    .dest-print .addr{font-size:10.5pt;}
    .dest-print .name{font-size:13pt; font-weight:700;} /* 大きく太字 */
    .dest-print .tel, .dest-print .date{font-size:9.5pt; color:#111;}

    /* 会社情報は右寄せ（ロゴも右） */
    .company-print-grid{
      display:grid; grid-template-columns:1fr auto; align-items:start; gap:8pt; margin-top:0
    }
    .company-info{ text-align:right; }
    .brand-block{ text-align:right; }
    .company-info .logo{ margin:0 0 6pt auto; max-height:28mm; } /* 右寄せ */
    .company-contacts{font-size:10pt; line-height:1.6; }
    #brandName{font-size:12pt; font-weight:700;} /* 住所より大きく */

    /* LINE画像サイズ（印刷） */
    .line-row .icon, .line-row .qr{width:90px; height:90px}

    /* 表：実線+ヘッダー繰返し+行分割回避 */
    table{border-collapse:collapse; border-spacing:0}
    thead{display:table-header-group}
    tfoot{display:table-footer-group}
    th, td{
      border:1pt solid #000 !important;
      padding:6pt 5pt !important;
      background:#fff !important;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
      page-break-inside:avoid;
    }
    th{font-weight:700}
    tr{page-break-inside:avoid}

    /* 入力ボックスは“文字だけ”に見せる */
    input, textarea, select{
      border:none !important; outline:none !important; box-shadow:none !important;
      background:transparent !important; padding:0 !important; margin:0 !important;
      -webkit-appearance:none; appearance:none;
    }
    td input[type="number"], td input[type="text"]{
      width:auto !important; min-width:0 !important;
    }

    /* B寄り視線誘導：合計を網掛け＆強調 */
    .grand-wrap table tr.grand th, .grand-wrap table tr.grand td{
      background:var(--shade) !important; font-weight:700; border-top:2pt solid #000
    }
    .grand{font-size:13pt}

    /* 空の追加工事は非表示 */
    #extras:has(tbody:empty){display:none}
    #extrasHead:has(+ #extras tbody:empty){display:none}
  }
</style>
</head>
<body>

<header class="appbar no-print">
  <h1>お見積書（B仕上げ・印刷は題名から） v7.3.1R PrintPro</h1>
  <div class="actions">
    <button class="icon" onclick="addItem()">+明細行</button>
    <button class="primary" onclick="window.print()">印刷</button>
  </div>
</header>

<div class="container">
  <!-- 入力カード（印刷非表示） -->
  <div class="card">
    <div class="row">
      <div>
        <label>お客様のご住所</label>
        <input id="inAddr" type="text" placeholder="例）〒526-0102 滋賀県長浜市曽根町..." inputmode="text" />
      </div>
      <div>
        <label>お客様のお名前</label>
        <input id="inName" type="text" placeholder="例）北側 ヒトミ" inputmode="text" />
      </div>
      <div>
        <label>お客様の電話番号</label>
        <input id="inTel" type="tel" placeholder="例）0749-72-2406" inputmode="tel" />
      </div>
      <div>
        <label>有効期限 / 見積日（任意）</label>
        <input id="inDate" type="text" placeholder="例）2025年10月25日まで有効" inputmode="text" />
      </div>
    </div>
  </div>

  <div class="card sheet" id="printArea">
    <h2>お見積書</h2>

    <!-- 宛名ブロック（印刷専用・左） -->
    <div id="destPrint" class="dest-print" style="display:none">
      <div id="pAddr" class="addr"></div>
      <div class="name"><span id="pName"></span></div>
      <div id="pTel" class="tel"></div>
      <div id="pDate" class="date"></div>
    </div>

    <!-- 会社情報（右寄せ）／LINE -->
    <div class="company-print-grid">
      <div></div> <!-- 左側は空（宛名が入る想定） -->
      <div class="company-info">
        <div class="brand-block">
          <img class="logo" id="companyLogo" src="data:image/png;base64,{{COMPANY_LOGO_BASE64}}" alt="株式会社ピアレキタガワ ロゴ">
          <div id="brandName">株式会社ピアレキタガワ</div>
          <div class="company-contacts">
            <div>〒526-0102 滋賀県長浜市曽根町350</div>
            <div>TEL：0749-72-2406</div>
          </div>
        </div>
        <div class="company-line">
          <div class="line-row">
            <img class="icon" id="lineIcon" src="data:image/png;base64,{{LINE_ICON_BASE64}}" alt="LINEロゴ">
            <img class="qr" id="lineQr" src="data:image/png;base64,{{LINE_QR_BASE64}}" alt="LINE公式アカウントQR">
          </div>
          <div class="line-note">LINEからもお気軽にご連絡ください</div>
        </div>
      </div>
    </div>

    <!-- 画面用の宛名（従来どおり表示） -->
    <div class="header-flex no-print">
      <div class="dest">
        <div id="destAddress" style="font-size:12pt;"></div>
        <div class="name"><span id="destName"></span><span> 様</span></div>
        <div id="destTel" style="font-size:10pt;"></div>
        <div id="destDate" class="muted" style="font-size:9pt;"></div>
      </div>
    </div>

    <!-- 明細 -->
    <div class="section-head" style="display:flex;align-items:center;gap:10px;margin:14px 0 6px">
      <div class="section-title">見積明細（エアコン本体など）</div>
      <button class="icon no-print" onclick="addItem()">+ 明細行を追加</button>
    </div>
    <table id="items">
      <thead>
        <tr>
          <th style="width:36%">品名・型番</th>
          <th style="width:10%">数量（台）</th>
          <th style="width:18%">単価（税込）</th>
          <th style="width:16%">小計（税込）</th>
          <th style="width:20%">備考</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- 標準取付工事費 -->
    <div class="section-head" style="display:flex;align-items:center;gap:10px;margin:14px 0 6px">
      <div class="section-title">標準取付工事費 <span class="muted">（1台 22,000円 税込固定）</span></div>
    </div>
    <table id="install">
      <thead>
        <tr>
          <th>内容</th>
          <th style="width:12%">台数</th>
          <th style="width:18%">単価（税込）</th>
          <th style="width:18%">小計（税込）</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>標準取付工事</td>
          <td><input type="number" min="0" step="1" value="1" oninput="recalc()" inputmode="numeric" /></td>
          <td class="num">
            <span class="print-hide">22,000</span>
            <span class="print-only">22,000</span>
          </td>
          <td class="num subtotal">22,000</td>
        </tr>
      </tbody>
    </table>

    <!-- 追加工事 -->
    <div id="extrasHead" class="section-head" style="display:flex;align-items:center;gap:10px;margin:14px 0 6px">
      <div class="section-title">追加工事</div>
      <button class="icon no-print" onclick="openAddWorks()">🧰 追加工事を選ぶ</button>
    </div>
    <table id="extras">
      <thead>
        <tr>
          <th style="width:42%">内容</th>
          <th style="width:10%">数量</th>
          <th style="width:8%">単位</th>
          <th style="width:18%">単価（税込）</th>
          <th style="width:14%">小計（税込）</th>
          <th style="width:8%">備考</th>
        </tr>
      </thead>
      <tbody>
        <!-- 空（選ぶまで表示なし） -->
      </tbody>
    </table>

    <!-- 合計（税込）のみ -->
    <div class="grand-wrap">
      <table>
        <tr class="grand"><th>合計 <span class="muted">（税込）</span></th><td id="sumGross" class="num">0</td></tr>
      </table>
    </div>

  </div>

  <!-- 追加工事の選択（モーダル） -->
  <div id="worksModal" class="no-print" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);padding:20px;z-index:50;">
    <div style="width:min(94vw,760px);max-height:80vh;overflow:auto;margin:6vh auto;background:#fff;border-radius:16px;border:1px solid var(--line);padding:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <strong style="font-size:18px">追加工事を選ぶ</strong>
        <button class="icon" onclick="closeAddWorks()">閉じる</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="icon" onclick="addExtra('配管延長', 3000, 'm')">配管延長（1m 3,000）</button>
        <button class="icon" onclick="addExtra('穴あけ工事（基礎RC以外）', 6600, 'か所')">穴あけ工事（1か所 6,600）</button>
        <button class="icon" onclick="addExtra('エアコン処理費（買い替え時）', 3190, '台')">エアコン処理費（1台 3,190）</button>
      </div>
    </div>
  </div>

</div>

<script>
function yen(n){return (Math.round(n)||0).toLocaleString('ja-JP')}
function parseNum(v){return parseFloat((v||'').toString().replace(/,/g,''))||0}

function addItem(name='', qty=1, unitPrice=0, note=''){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="品名・型番" value="${name}" inputmode="text"></td>
    <td><input type="number" min="0" step="1" value="${qty}" oninput="recalc()" inputmode="numeric"></td>
    <td class="num">
      <input class="print-hide" type="number" min="0" step="1" value="${unitPrice}" oninput="recalc()" inputmode="numeric">
      <span class="print-only price-view"></span>
    </td>
    <td class="num subtotal">0</td>
    <td class="notes-cell"><input type="text" placeholder="備考（任意）" value="${note}"></td>
  `;
  document.querySelector('#items tbody').appendChild(tr);
  recalc();
}

function addExtra(label, unitPrice, unit, note=''){
  const tbody = document.querySelector('#extras tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${label}</td>
    <td><input type="number" min="0" step="1" value="1" oninput="recalc()" inputmode="numeric"></td>
    <td class="muted">${unit}</td>
    <td class="num">
      <input class="print-hide" type="number" min="0" step="1" value="${unitPrice}" oninput="recalc()" inputmode="numeric">
      <span class="print-only price-view"></span>
    </td>
    <td class="num subtotal">0</td>
    <td class="notes-cell"><input type="text" placeholder="備考（任意）" value="${note}"></td>
  `;
  tbody.appendChild(tr);
  recalc();
}

function recalc(){
  let total = 0;

  // 明細
  document.querySelectorAll('#items tbody tr').forEach(tr=>{
    const qty = parseNum(tr.querySelector('td:nth-child(2) input').value);
    const priceInput = tr.querySelector('td:nth-child(3) input');
    const unit = parseNum(priceInput.value);
    const sub = qty * unit;
    tr.querySelector('.subtotal').textContent = yen(sub);
    const pv = tr.querySelector('.price-view');
    if(pv) pv.textContent = yen(unit);
    total += sub;
  });

  // 標準取付工事
  const instRow = document.querySelector('#install tbody tr');
  if(instRow){
    const qty = parseNum(instRow.querySelector('td:nth-child(2) input').value);
    const unit = 22000;
    const sub = qty * unit;
    instRow.querySelector('.subtotal').textContent = yen(sub);
    total += sub;
  }

  // 追加工事
  document.querySelectorAll('#extras tbody tr').forEach(tr=>{
    const qty = parseNum(tr.querySelector('td:nth-child(2) input').value);
    const priceInput = tr.querySelector('td:nth-child(4) input');
    const unit = parseNum(priceInput.value);
    const sub = qty * unit;
    tr.querySelector('.subtotal').textContent = yen(sub);
    const pv = tr.querySelector('.price-view');
    if(pv) pv.textContent = yen(unit);
    total += sub;
  });

  document.getElementById('sumGross').textContent = yen(total);

  // 画面の宛名表示を同期
  syncDestDisplay();
}

// 宛名の表示（画面＆印刷）を同期
function syncDestDisplay(){
  const addr = document.getElementById('inAddr').value.trim();
  const name = document.getElementById('inName').value.trim();
  const tel  = document.getElementById('inTel').value.trim();
  const date = document.getElementById('inDate').value.trim();

  // 画面用（従来）
  document.getElementById('destAddress').textContent = addr || '';
  document.getElementById('destName').textContent = name || '';
  document.getElementById('destTel').textContent = tel || '';
  document.getElementById('destDate').textContent = date || '';

  // 印刷用（氏名は「様」自動付与）
  const dp = document.getElementById('destPrint');
  const hasAny = addr || name || tel || date;
  dp.style.display = hasAny ? 'block' : 'none';
  document.getElementById('pAddr').textContent = addr || '';
  document.getElementById('pName').textContent = name ? (name + ' 様') : '';
  document.getElementById('pTel').textContent  = tel  || '';
  document.getElementById('pDate').textContent = date || '';
}

// 入力に反応して宛名を即時同期
['inAddr','inName','inTel','inDate'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', syncDestDisplay);
});

// 初期1行
addItem('', 1, 0, '');
recalc();
syncDestDisplay();

function openAddWorks(){document.getElementById('worksModal').style.display='block'}
function closeAddWorks(){document.getElementById('worksModal').style.display='none'}

/* 印刷直前：単価の会計表示＆宛名同期を念押し更新 */
function beforePrintTidy(){
  recalc();
  syncDestDisplay();
}
if('onbeforeprint' in window){
  window.addEventListener('beforeprint', beforePrintTidy);
} else {
  document.querySelectorAll('button[onclick="window.print()"]').forEach(btn=>{
    btn.addEventListener('click', beforePrintTidy, {capture:true});
  });
}
</script>

</body>
</html>

